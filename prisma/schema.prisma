generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

model Volunteer {
  id           String      @id @default(cuid())
  firstName    String
  lastName     String
  email        String      @unique
  phone        String
  address      String?
  dateOfBirth  DateTime?
  gender       String?
  skills       String?
  experience   String?
  availability String?
  status       String      @default("pending")
  notes        String      @default("")
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id])
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
}

model Department {
  id          String      @id @default(cuid())
  name        String      @unique
  description String
  leader      String      @default("")
  icon        String      @default("Users")
  volunteers  Volunteer[]
}

model Event {
  id                 String              @id @default(cuid())
  title              String
  description        String?
  date               DateTime
  time               String?
  endTime            String?
  location           String?
  image              String?
  category           String              @default("general")
  featured           Boolean             @default(false)
  published          Boolean             @default(true)
  registrationOpen   Boolean             @default(false)
  registrationDeadline DateTime?
  maxCapacity        Int?
  requireApproval    Boolean             @default(false)
  ticketTypes        EventTicketType[]
  registrations      EventRegistration[]
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
}

model EventTicketType {
  id            String              @id @default(cuid())
  eventId       String
  event         Event               @relation(fields: [eventId], references: [id], onDelete: Cascade)
  name          String
  description   String?
  price         Float               @default(0)
  currency      String              @default("CAD")
  quantity      Int?
  maxPerOrder   Int                 @default(10)
  isFree        Boolean             @default(true)
  sortOrder     Int                 @default(0)
  registrations EventRegistration[]
  createdAt     DateTime            @default(now())
}

model EventRegistration {
  id             String          @id @default(cuid())
  eventId        String
  event          Event           @relation(fields: [eventId], references: [id], onDelete: Cascade)
  ticketTypeId   String
  ticketType     EventTicketType @relation(fields: [ticketTypeId], references: [id], onDelete: Cascade)
  ticketCode     String          @unique
  firstName      String
  lastName       String
  email          String
  phone          String?
  numberOfTickets Int            @default(1)
  status         String          @default("confirmed")
  checkedIn      Boolean         @default(false)
  checkedInAt    DateTime?
  notes          String?
  createdAt      DateTime        @default(now())
}

model Sermon {
  id           String   @id @default(cuid())
  title        String
  speaker      String
  date         DateTime @default(now())
  youtubeUrl   String?
  series       String?
  description  String?
  thumbnailUrl String?
  featured     Boolean  @default(false)
  published    Boolean  @default(true)
  createdAt    DateTime @default(now())
}

model Donation {
  id              String   @id @default(cuid())
  amount          Float
  currency        String   @default("CAD")
  category        String
  donorName       String   @default("Anonymous")
  donorEmail      String?
  stripeSessionId String?
  status          String   @default("pending")
  createdAt       DateTime @default(now())
}

model Admin {
  id       String @id @default(cuid())
  email    String @unique
  password String
  name     String
  role     String @default("admin")
}

model ContactMessage {
  id        String   @id @default(cuid())
  name      String
  email     String
  phone     String?
  subject   String
  message   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
}

// ─── Community / Social Platform ───────────────────

model Member {
  id            String              @id @default(cuid())
  email         String              @unique
  password      String
  firstName     String
  lastName      String
  displayName   String
  avatar        String?
  bio           String?
  phone         String?
  isOnline      Boolean             @default(false)
  lastSeen      DateTime            @default(now())
  role          String              @default("member") // member, moderator, leader
  verified      Boolean             @default(false)
  pushToken     String?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  messages      ChatMessage[]
  roomMembers   ChatRoomMember[]
  reactions     MessageReaction[]
  dmSent        DirectMessage[]     @relation("DMSender")
  dmReceived    DirectMessage[]     @relation("DMReceiver")
  convMember1   DirectConversation[] @relation("ConvMember1")
  convMember2   DirectConversation[] @relation("ConvMember2")
}

model ChatRoom {
  id          String           @id @default(cuid())
  name        String
  description String?
  icon        String           @default("MessageCircle")
  type        String           @default("public")  // public, private, announcement
  color       String           @default("#7B2D3B")
  pinned      Boolean          @default(false)
  archived    Boolean          @default(false)
  createdBy   String?
  messages    ChatMessage[]
  members     ChatRoomMember[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
}

model ChatRoomMember {
  id        String   @id @default(cuid())
  roomId    String
  room      ChatRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  memberId  String
  member    Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  role      String   @default("member")  // member, moderator, admin
  muted     Boolean  @default(false)
  lastRead  DateTime @default(now())
  joinedAt  DateTime @default(now())

  @@unique([roomId, memberId])
}

model ChatMessage {
  id        String            @id @default(cuid())
  roomId    String
  room      ChatRoom          @relation(fields: [roomId], references: [id], onDelete: Cascade)
  senderId  String
  sender    Member            @relation(fields: [senderId], references: [id], onDelete: Cascade)
  content   String
  type      String            @default("text")  // text, image, link, system, scripture
  replyToId String?
  replyTo   ChatMessage?      @relation("MessageReplies", fields: [replyToId], references: [id], onDelete: SetNull)
  replies   ChatMessage[]     @relation("MessageReplies")
  reactions MessageReaction[]
  edited    Boolean           @default(false)
  deleted   Boolean           @default(false)
  pinned    Boolean           @default(false)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
}

model MessageReaction {
  id        String      @id @default(cuid())
  messageId String
  message   ChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  memberId  String
  member    Member      @relation(fields: [memberId], references: [id], onDelete: Cascade)
  emoji     String
  createdAt DateTime    @default(now())

  @@unique([messageId, memberId, emoji])
}

model DirectConversation {
  id        String          @id @default(cuid())
  member1Id String
  member1   Member          @relation("ConvMember1", fields: [member1Id], references: [id], onDelete: Cascade)
  member2Id String
  member2   Member          @relation("ConvMember2", fields: [member2Id], references: [id], onDelete: Cascade)
  messages  DirectMessage[]
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  @@unique([member1Id, member2Id])
}

model DirectMessage {
  id             String             @id @default(cuid())
  conversationId String
  conversation   DirectConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderId       String
  sender         Member             @relation("DMSender", fields: [senderId], references: [id], onDelete: Cascade)
  receiverId     String
  receiver       Member             @relation("DMReceiver", fields: [receiverId], references: [id], onDelete: Cascade)
  content        String
  type           String             @default("text")
  read           Boolean            @default(false)
  deleted        Boolean            @default(false)
  createdAt      DateTime           @default(now())
}
